# @package _global_
defaults:
  - /configs/eval_base.yaml
  - _self_

# ============================================================================
# Paths Configuration for Chicken Detection Zero-Shot Evaluation
# ============================================================================
paths:
  checkpoint_path: checkpoints/sam3.pt  # Will be overridden via command line
  experiment_log_dir: results/zero_shot_baseline  # Will be overridden via command line
  coco_gt: data/chicken_val.json  # Will be overridden via command line
  img_path: data/images  # Will be overridden via command line
  bpe_path: sam3/assets/bpe_simple_vocab_16e6.txt.gz  # Will be overridden via command line

# ============================================================================
# Trainer Configuration
# ============================================================================

trainer:
  data:
    val:
      _target_: sam3.train.data.torch_dataset.TorchDataset
      dataset:
        _target_: sam3.train.data.sam3_image_dataset.Sam3ImageDataset
        coco_json_loader:
          _target_: sam3.train.data.coco_json_loaders.SAM3_EVAL_API_FROM_JSON_NP
          _partial_: true
        img_folder: ${paths.img_path}
        ann_file: ${paths.coco_gt}
        transforms: ${scratch.base_val_transform}
        max_ann_per_img: 100000
        multiplier: 1
        training: false

      shuffle: False
      batch_size: ${scratch.val_batch_size}
      num_workers: ${scratch.num_val_workers}
      pin_memory: False
      drop_last: False
      collate_fn:
        _target_: sam3.train.data.collator.collate_fn_api
        _partial_: true
        repeats: ${scratch.hybrid_repeats}
        dict_key: chicken_val

  meters:
    val:
      chicken_val: # this key matches the "dict_key" in the dataloader's collate function
        cgf1:
          _target_: sam3.eval.coco_writer.PredictionDumper
          iou_type: "segm"
          dump_dir: ${launcher.experiment_log_dir}/dumps/chicken_val
          merge_predictions: True
          postprocessor: ${scratch.mask_postprocessor_thresholded}
          gather_pred_via_filesys: ${scratch.gather_pred_via_filesys}
          maxdets: 1000000 # no limit
          pred_file_evaluators:
            - _target_: sam3.eval.cgf1_eval.CGF1Evaluator
              gt_path: ${paths.coco_gt}
              iou_type: "bbox"
            - _target_: sam3.eval.cgf1_eval.CGF1Evaluator
              gt_path: ${paths.coco_gt}
              iou_type: "segm"

# ============================================================================
# Launcher Configuration (for local execution)
# ============================================================================

launcher:
  num_nodes: 1
  gpus_per_node: 1
  experiment_log_dir: ${paths.experiment_log_dir}
  multiprocessing_context: forkserver
